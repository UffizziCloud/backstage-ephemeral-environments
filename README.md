<p align="center">   
  <a href="https://uffizzi.com">
    <img alt="Uffizzi" src="https://avatars.githubusercontent.com/u/68303350?s=200&v=4" width="100" />
  </a>
  <a href="https://backstage.io">
    <img alt="Backstage" src="public/backstage.jpeg" height="100" />
  </a>
</p>
<h1 align="center">
 Uffizzi Ephemeral Environments for Backstage
</h1>
<p align="center">
This repo provides the skeleton to get you started with using <a href="https://github.com/UffizziCloud/uffizzi">Uffizzi</a> to create ephemeral environments for <a href="https://github.com/backstage/backstage">Backstage</a> developemt. To better understand the whole system check out our blog on Backstage development here. Follow the steps below to try out the previews for Backstage and better understand how the previews are build.
</p>

## Try out Uffizzi

1. Fork the repo
2. Create a small change anywhere in the repo
3. Create a pull requests with the change commit against the `uffizzi` branch to trigger the Github action workflows to see Uffizzi in action !

The following section provides information on how the ephemeral environments work.

## Ephemeral environment builds for Backstage

### Repository structure

The `uffizzi-backstage` folder was generated by runnning the following command :

```bash
npx @backstage/create-app@latest
```

The above command also runs `yarn install` after generating the files for the backstage instance. You can go in the folder and run `yarn dev` to test the backstage instance locally.  

The folder also contains a `docker-compose.yml` which can be used for local development using docker-compose. A similar file `docker-compose.uffizzi.yml` is the earlier docker-compose with Uffizzi configuration, plus a few other edits for the configuration to work with Uffizzi. These files were added by the Uffizzi team. We will discuss this in detail in the further sections. 


### Application architecture 

The following is the architecutre of the Backstage application we will be building and previewing in Uffizzi in this repo. 


<!-- ![alt text](public/architecture.png?raw=true "Architecture") -->

Let's look at what the Uffizzi configuration looks like and what configuration we need to add to make the above possible. 


### The Uffizzi configuration

The `docker-compose.uffizzi.yml` in the root of the repo is the main configuration file for Uffizzi. It is an everyday docker-compose file with the following changes made to it :-

1. The `x-uffizzi` configuration. 

```yaml
x-uffizzi:
  ingress:
    service: frontend
    port: 8000
```

The above configuration let's the Uffizzi engine know that this docker-compose file has been configured for Uffizzi. Here we define the ingress which points to the frontend of the application. The final Uffizzi URL for the ephemeral environment is created routes requests directly to the frontend service in this case.

2. Values for the `image` parameter for the services which need to be built on every change.

The values for these are are updated to use ${BACKSTAGE_IMAGE} and the ${STOREFRONT_IMAGE} placeholders instead of local build contexts so that we can replace these placeholders with the image tags from the github action builds.

Considering that the frontend has been configured to consume the backend service, let's see how the backstage backend consumes the postgres and the redis services.

###  Backstage configuration for Uffizzi


## Next steps

To learn more above creating epehemral environments for Backstage applications, check out our blog here and if you have any issues setting up Uffizzi or configuring Backstage, follow the links below.

Visit [docs.uffizzi.com](https://docs.uffizzi.com) for more information on epehemeral environments.
Visit [backstage.io](https://backstage.io) for further guides on Backstage development.
